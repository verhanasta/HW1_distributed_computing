name: Deploy WordPress

on:
  push:
    branches:
      - develop

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.x

      - name: Install Ansible and dependencies
        run: |
          pip install ansible docker
          ansible-galaxy collection install community.docker

      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H 51.250.9.118 >> ~/.ssh/known_hosts

      - name: Run playbook
        run: |
          ansible-playbook -i ansible/inventory.ini ansible/deploy.yml

      - name: Wait for containers to start and verify site
        run: |
          echo "‚è≥ –ñ–¥—ë–º 30 —Å–µ–∫—É–Ω–¥, —á—Ç–æ–±—ã —Å–µ—Ä–≤–∏—Å—ã —É—Å–ø–µ–ª–∏ –ø–æ–¥–Ω—è—Ç—å—Å—è..."
          sleep 30
          
          echo "üåê –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–∞–π—Ç–∞ https://51.250.9.118.sslip.io ..."
          STATUS=$(curl -L -k -s -o /dev/null -w '%{http_code}' https://51.250.9.118.sslip.io)
          echo "HTTP Status Code: $STATUS"
          
          if [ "$STATUS" != "200" ]; then
            echo "‚ùå –°–∞–π—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ."
            exit 1
          fi
          
          echo "‚úÖ –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ."