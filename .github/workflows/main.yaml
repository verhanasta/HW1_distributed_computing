name: üöÄ Deploy to Server

on:
  push:
    branches: [ develop ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üßæ Checkout Repository
        uses: actions/checkout@v3

      - name: üîê Set up SSH
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: üîÑ Force update known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keygen -R 51.250.9.118 -f ~/.ssh/known_hosts || true
          ssh-keyscan -H 51.250.9.118 >> ~/.ssh/known_hosts
          cat ~/.ssh/known_hosts

      - name: üì¶ Copy Project to Server
        run: |
          ssh verhanasta@51.250.9.118 "rm -rf ~/project"
          scp -r ./ verhanasta@51.250.9.118:~/project

      - name: üßº Clean Up Old Containers
        run: ssh verhanasta@51.250.9.118 "docker rm -f \$(docker ps -aq) || true"

      - name: üß∞ Install Ansible (if not installed)
        run: ssh verhanasta@51.250.9.118 "command -v ansible-playbook || (sudo apt update && sudo apt install -y ansible)"

      - name: üïµÔ∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ SSH
        run: ssh -o StrictHostKeyChecking=no verhanasta@51.250.9.118 "echo '‚úÖ SSH —Ä–∞–±–æ—Ç–∞–µ—Ç!'"

      - name: üöÄ Run Ansible Playbook
        run: ssh verhanasta@51.250.9.118 "cd ~/project && ansible-playbook -i ansible/inventory.ini ansible/deploy.yml"

      - name: üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–∞–π—Ç–∞
        run: |
          echo "‚è≥ –ñ–¥—ë–º 30 —Å–µ–∫—É–Ω–¥, —á—Ç–æ–±—ã —Å–µ—Ä–≤–∏—Å—ã —É—Å–ø–µ–ª–∏ –ø–æ–¥–Ω—è—Ç—å—Å—è..."
          sleep 30
          echo "üåê –ü—Ä–æ–≤–µ—Ä—è–µ–º https://51.250.9.118.sslip.io ..."
          STATUS=$(curl -L -s -k -o /dev/null -w '%{http_code}' https://51.250.9.118.sslip.io)
          echo "HTTP Status Code: $STATUS"
          if [ "$STATUS" != "200" ]; then
            echo "‚ùå –°–∞–π—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ."
            exit 1
          fi
          echo "‚úÖ –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ."
