name: üöÄ Production Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v3

      - name: üîê Set up SSH Agent
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: üìù Save SSH key to file
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > id_rsa
          chmod 600 id_rsa

      - name: üîë Add remote host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "${{ secrets.SSH_HOST }}" >> ~/.ssh/known_hosts
          cat ~/.ssh/known_hosts

      - name: üêç Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: üì¶ Install Ansible and Docker collection
        run: |
          python -m pip install --upgrade pip
          pip install ansible
          ansible-galaxy collection install community.docker

      - name: üìÅ Create Ansible inventory file
        run: |
          echo "[production]" > inventory.ini
          echo "${{ secrets.SSH_HOST }} ansible_user=${{ secrets.SSH_USER }} ansible_ssh_private_key_file=${{ github.workspace }}/id_rsa" >> inventory.ini
          cat inventory.ini

      - name: üöÄ Run Ansible Playbook
        run: |
          ansible-playbook -i inventory.ini deploy.yml

      - name: ‚úÖ Check website status
        run: |
          echo "‚è≥ –ñ–¥—ë–º 60 —Å–µ–∫—É–Ω–¥, —á—Ç–æ–±—ã —Å–µ—Ä–≤–∏—Å—ã —É—Å–ø–µ–ª–∏ –ø–æ–¥–Ω—è—Ç—å—Å—è..."
          sleep 60
          
          echo "üåê –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å: http://${{ secrets.SSH_HOST }}:8080"
          STATUS=$(curl -L -s -o /dev/null -w '%{http_code}' http://${{ secrets.SSH_HOST }}:8080)
          echo "üì∂ HTTP Status Code: $STATUS"

          if [ "$STATUS" != "200" ]; then
            echo "‚ùå –°–∞–π—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ."
            exit 1
          fi

          echo "‚úÖ –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!"
