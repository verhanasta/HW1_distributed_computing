name: Deploy WordPress

on:
  push:
    branches:
      - develop

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üì• –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4

      - name: üîë –£—Å—Ç–∞–Ω–æ–≤–∫–∞ SSH-–∫–ª—é—á–∞
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 51.250.9.118 >> ~/.ssh/known_hosts

      - name: üõ†Ô∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Ansible –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        run: |
          ssh verhanasta@51.250.9.118 << 'EOF'
            sudo apt update
            sudo apt install -y ansible
          EOF

      - name: üßπ –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º
        run: |
          ssh verhanasta@51.250.9.118 << 'EOF'
            echo "üßπ –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
            docker rm -f $(docker ps -aq) 2>/dev/null || true

            echo "üßº –ß–∏—Å—Ç–∏–º –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ Docker-—Å–µ—Ç–∏..."
            docker network prune -f
          EOF

      - name: üöÄ –ó–∞–ø—É—Å–∫ –¥–µ–ø–ª–æ—è —á–µ—Ä–µ–∑ Ansible
        run: |
          ssh verhanasta@51.250.9.118 "ansible-playbook -i ~/inventory.ini ~ansible/deploy.yml"

      - name: ‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
        run: sleep 30

      - name: üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–∞–π—Ç–∞
        run: |
          STATUS=$(curl -L -k -s -o /dev/null -w '%{http_code}' https://51.250.9.118.sslip.io:8443)
          echo "HTTP Status Code: $STATUS"

          if [ "$STATUS" != "200" ]; then
            echo "‚ùå –°–∞–π—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ."
            exit 1
          fi

          echo "‚úÖ –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ."
